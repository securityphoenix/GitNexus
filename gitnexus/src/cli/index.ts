#!/usr/bin/env node

// Raise Node heap limit for large repos (e.g. Linux kernel).
// Must run before any heavy allocation. If already set by the user, respect it.
if (!process.env.NODE_OPTIONS?.includes('--max-old-space-size')) {
  const execArgv = process.execArgv.join(' ');
  if (!execArgv.includes('--max-old-space-size')) {
    // Re-spawn with a larger heap (8 GB)
    const { execFileSync } = await import('node:child_process');
    try {
      execFileSync(process.execPath, ['--max-old-space-size=8192', ...process.argv.slice(1)], {
        stdio: 'inherit',
        env: { ...process.env, NODE_OPTIONS: `${process.env.NODE_OPTIONS || ''} --max-old-space-size=8192`.trim() },
      });
      process.exit(0);
    } catch (e: any) {
      // If the child exited with an error code, propagate it
      process.exit(e.status ?? 1);
    }
  }
}

import { Command } from 'commander';
import { analyzeCommand } from './analyze.js';
import { serveCommand } from './serve.js';
import { listCommand } from './list.js';
import { statusCommand } from './status.js';
import { mcpCommand } from './mcp.js';
import { cleanCommand } from './clean.js';
import { setupCommand } from './setup.js';
import { augmentCommand } from './augment.js';
import { wikiCommand } from './wiki.js';
import { queryCommand, contextCommand, impactCommand, cypherCommand } from './tool.js';
import { evalServerCommand } from './eval-server.js';
import { githubLoginCommand, githubScanCommand } from './github.js';
import { keysCreateCommand, keysListCommand } from './keys.js';
import { reportCommand } from './report.js';
const program = new Command();

program
  .name('gitnexus')
  .description('GitNexus local CLI and MCP server')
  .version('1.2.0');

program
  .command('setup')
  .description('One-time setup: configure MCP for Cursor, Claude Code, OpenCode')
  .action(setupCommand);

program
  .command('analyze [path]')
  .description('Index a repository (full analysis)')
  .option('-f, --force', 'Force full re-index even if up to date')
  .option('--embeddings', 'Enable embedding generation for semantic search (off by default)')
  .action(analyzeCommand);

program
  .command('serve')
  .description('Start local HTTP server for web UI connection')
  .option('-p, --port <port>', 'Port number', '4747')
  .option('--host <host>', 'Bind address (default: 127.0.0.1, use 0.0.0.0 for remote access)')
  .action(serveCommand);

program
  .command('mcp')
  .description('Start MCP server (stdio) — serves all indexed repos')
  .action(mcpCommand);

program
  .command('list')
  .description('List all indexed repositories')
  .action(listCommand);

program
  .command('status')
  .description('Show index status for current repo')
  .action(statusCommand);

program
  .command('clean')
  .description('Delete GitNexus index for current repo')
  .option('-f, --force', 'Skip confirmation prompt')
  .option('--all', 'Clean all indexed repos')
  .action(cleanCommand);

program
  .command('wiki [path]')
  .description('Generate repository wiki from knowledge graph')
  .option('-f, --force', 'Force full regeneration even if up to date')
  .option('--model <model>', 'LLM model name (default: minimax/minimax-m2.5)')
  .option('--base-url <url>', 'LLM API base URL (default: OpenAI)')
  .option('--api-key <key>', 'LLM API key (saved to ~/.gitnexus/config.json)')
  .option('--concurrency <n>', 'Parallel LLM calls (default: 3)', '3')
  .option('--gist', 'Publish wiki as a public GitHub Gist after generation')
  .action(wikiCommand);

// ─── GitHub Integration ───────────────────────────────────────────
const github = program
  .command('github')
  .description('GitHub integration for scanning repositories');

github
  .command('login')
  .description('Store GitHub PAT for user/org/repos')
  .option('-t, --type <type>', 'Credential type: user | org | repos', 'user')
  .option('-o, --owner <owner>', 'GitHub owner (username, org, or owner/repo)')
  .option('--token <token>', 'GitHub PAT (or set GITHUB_TOKEN)')
  .action(githubLoginCommand);

github
  .command('scan <target>')
  .description('Scan GitHub repos and index them locally')
  .option('-t, --type <type>', 'Scan type: user | org | repos', 'user')
  .option('--token <token>', 'GitHub PAT (optional)')
  .option('-f, --force', 'Force re-index even if up to date')
  .action(githubScanCommand);

// ─── Remote Report Command ───────────────────────────────────────
program
  .command('report <target>')
  .description('Clone remote repo, analyze it, generate detailed MD report, and cleanup')
  .option('-o, --output <dir>', 'Output directory for the report')
  .option('--token <token>', 'GitHub PAT for private repos (or set GITHUB_TOKEN)')
  .option('--code', 'Include code snippets in the report')
  .option('--keep', 'Keep the cloned repository (do not delete after analysis)')
  .action(reportCommand);

// ─── API Keys ─────────────────────────────────────────────────────
const keys = program
  .command('keys')
  .description('Manage GitNexus API keys');

keys
  .command('create')
  .description('Create a new API key')
  .option('-n, --name <name>', 'Key name')
  .option('-s, --scopes <scopes>', 'Comma-separated scopes (read,write,admin)', 'read')
  .action(keysCreateCommand);

keys
  .command('list')
  .description('List existing API keys')
  .action(keysListCommand);

program
  .command('augment <pattern>')
  .description('Augment a search pattern with knowledge graph context (used by hooks)')
  .action(augmentCommand);

// ─── Direct Tool Commands (no MCP overhead) ────────────────────────
// These invoke LocalBackend directly for use in eval, scripts, and CI.

program
  .command('query <search_query>')
  .description('Search the knowledge graph for execution flows related to a concept')
  .option('-r, --repo <name>', 'Target repository (omit if only one indexed)')
  .option('-c, --context <text>', 'Task context to improve ranking')
  .option('-g, --goal <text>', 'What you want to find')
  .option('-l, --limit <n>', 'Max processes to return (default: 5)')
  .option('--content', 'Include full symbol source code')
  .action(queryCommand);

program
  .command('context [name]')
  .description('360-degree view of a code symbol: callers, callees, processes')
  .option('-r, --repo <name>', 'Target repository')
  .option('-u, --uid <uid>', 'Direct symbol UID (zero-ambiguity lookup)')
  .option('-f, --file <path>', 'File path to disambiguate common names')
  .option('--content', 'Include full symbol source code')
  .action(contextCommand);

program
  .command('impact <target>')
  .description('Blast radius analysis: what breaks if you change a symbol')
  .option('-d, --direction <dir>', 'upstream (dependants) or downstream (dependencies)', 'upstream')
  .option('-r, --repo <name>', 'Target repository')
  .option('--depth <n>', 'Max relationship depth (default: 3)')
  .option('--include-tests', 'Include test files in results')
  .action(impactCommand);

program
  .command('cypher <query>')
  .description('Execute raw Cypher query against the knowledge graph')
  .option('-r, --repo <name>', 'Target repository')
  .action(cypherCommand);

// ─── Eval Server (persistent daemon for SWE-bench) ─────────────────

program
  .command('eval-server')
  .description('Start lightweight HTTP server for fast tool calls during evaluation')
  .option('-p, --port <port>', 'Port number', '4848')
  .option('--idle-timeout <seconds>', 'Auto-shutdown after N seconds idle (0 = disabled)', '0')
  .action(evalServerCommand);

program.parse(process.argv);
